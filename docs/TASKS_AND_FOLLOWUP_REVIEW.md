# مراجعة قسم المهام والمتابعة والتحصيل من الزبائن

## 1. الآلية الحالية (ما تم مراجعته)

### 1.1 مصدر البيانات
- **جدول `crm_activities`** في Supabase: يسجل كل تفاعل (اتصال، واتساب، زيارة، بريد) مع الزبون، مع وعود السداد (PTP) وتواريخ المتابعة.
- **واجهة المهام** (`/admin/tasks`): تعرض المهام مجمّعة في ثلاثة أعمدة:
  - **وعود فائتة/متأخرة** (Overdue)
  - **وعود اليوم** (Today)
  - **وعود قادمة** (Upcoming)

### 1.2 الإجراءات المتاحة على كل مهمة
- **تم الدفع**: تحديث حالة الموعد إلى Fulfilled (مُنفّذ).
- **لم يجب**: أرشفة الموعد الحالي وإنشاء موعد جديد بعد يومين بنفس المبلغ.
- **إعادة جدولة**: أرشفة الموعد الحالي وإنشاء موعد جديد بالتاريخ والملاحظات الجديدة.
- **نسخ تفاعل**: إنشاء تفاعل جديد لزبون (نفسه أو غيره) بنفس المبلغ/الملاحظات وتاريخ مختلف.

### 1.3 أماكن إضافة/تعديل التفاعلات
- من **صفحة الزبائن** (`/admin/customers`): زر "تفاعل" وقطاع "مهام المتابعة" بنفس إجراءات (تم الدفع، لم يجب، إعادة جدولة، نسخ).
- من **ملف الزبون** (`/admin/customers/[id]`): إضافة تفاعل جديد أو تعديل تفاعل موجود عبر نفس المودال.

---

## 2. التحسينات المُنفّذة (التوثيق حسب الموظف)

### 2.1 توثيق من أنشأ التفاعل (created_by)
- **قبل**: الحقل `created_by` في `crm_activities` كان يُحفظ دائماً كقيمة ثابتة `"Admin"`.
- **بعد**:
  - عند **إضافة تفاعل جديد** (من المودال في الزبائن أو ملف الزبون): يُمرَّر معرف الموظف الحالي (`admin.id`) ويُحفظ في `created_by`.
  - عند **لم يجب / إعادة جدولة / نسخ تفاعل** من صفحة المهام أو صفحة الزبائن: التفاعل الجديد يُسجَّل مع `created_by = admin.id`.

### 2.2 توثيق من حدّث الحالة (updated_by)
- **ترحيل قاعدة البيانات**: إضافة عمود `updated_by` إلى `crm_activities` (انظر `migrations/add_updated_by_to_crm_activities.sql`).
- عند استدعاء **تم الدفع** أو **أرشفة** (لم يجب / إعادة جدولة): يُمرَّر `admin.id` ويُحفظ في `updated_by` للسجل المُحدَّث.

### 2.3 عرض التوثيق في الواجهة
- **صفحة المهام**: تحت كل بطاقة مهمة يظهر عند التوفر:
  - "أنشأه: [اسم المستخدم]"
  - "آخر تحديث: [اسم المستخدم]"
- **ملف الزبون**: في قسم التفاعلات/المتابعة يظهر نفس السطر (أنشأه / آخر تحديث) لكل تفاعل.

### 2.4 واجهة برمجة التطبيقات (API)
- `logActivity` و `logActivityToSupabase`: دعم معامل اختياري `created_by`.
- `updatePTPStatus` و `updatePTPStatusInSupabase`: دعم معامل اختياري `updated_by`.
- `getCRMDataFromSupabase`: جلب `created_by` و `updated_by` وحل أسماء المستخدمين من `admin_users` وإرجاعها كـ `CreatedByUsername` و `UpdatedByUsername`.
- `getCustomerData`: نفس الحقول وأسماء المستخدمين ضمن بيانات التفاعلات للعميل.

---

## 3. اقتراحات إضافية (لم تُنفَّذ بعد)

### 3.1 تعيين موظف مسؤول عن المتابعة (اختياري)
- إضافة حقل اختياري مثل `assigned_to` (معرف الموظف) في `crm_activities` أو في العميل، بحيث تظهر المهام للموظف المعيّن أو لفريقه فقط.
- يسمح بتوزيع الزبائن بين المحصلين وتقليل التداخل.

### 3.2 سجل تغييرات كامل (تعديلات التفاعل)
- عند **تعديل** تفاعل موجود (تعديل الملاحظات، التاريخ، المبلغ) من مودال "تعديل تفاعل":
  - حفظ `updated_by` و `updated_at` في نفس الجدول (إن وُجد دعم لتعديل التفاعل لاحقاً في الواجهة).
- للتدقيق الأقوى: جدول منفصل `crm_activity_history` (activity_id, changed_at, changed_by, field, old_value, new_value) لتسجيل كل تغيير.

### 3.3 إشعارات وتذكيرات
- إشعار للموظف (أو للمشرف) عند اقتراب موعد متابعة أو عند وجود وعود فائتة.
- يمكن ربطها بـ Notifications أو بريد أو تنبيهات داخل التطبيق إذا وُجدت آلية إشعارات.

### 3.4 تقارير وتحليلات
- تقرير "تحصيل حسب الموظف": إجمالي ما تم تحصيله (وعود مُنفّذة) لكل موظف في فترة زمنية.
- تقرير "وعود مكسورة": عدد وعود فائتة أو ملغاة حسب العميل أو الموظف.
- تصدير تفاعلات عميل مع تواريخ و"أنشأه/آخر تحديث" لاستخدامها في المراجعة أو التدقيق.

### 3.5 قواعد صلاحيات أدق
- صلاحية منفصلة مثل `manageTasks` (إنشاء/تعديل/حذف مهام) مقابل `viewTasks` (عرض فقط).
- إمكانية تقييد عرض المهام حسب الموظف أو حسب "من أنشأ التفاعل" أو "المعيّن للمتابعة" إذا تم تنفيذ 3.1.

### 3.6 تحسين تجربة المواعيد
- في مودال "إعادة الجدولة": اقتراح تواريخ (مثلاً بعد 3 أيام، أسبوع، أسبوعين) لتسريع الإدخال.
- حقل "سبب إعادة الجدولة" أو قائمة أسباب جاهزة لتحليل أسباب التأجيل لاحقاً.

---

## 4. تشغيل الترحيل (Migration)

لتطبيق عمود `updated_by` على قاعدة البيانات:

```bash
# من مجلد المشروع، تنفيذ الملف على Supabase (أو من لوحة Supabase SQL Editor)
psql $DATABASE_URL -f migrations/add_updated_by_to_crm_activities.sql
```

أو نسخ محتوى `migrations/add_updated_by_to_crm_activities.sql` وتشغيله من Supabase Dashboard → SQL Editor.

---

## 5. ملخص

| البند | الحالة |
|-------|--------|
| تسجيل من أنشأ كل تفاعل (created_by) | مُنفَّذ |
| تسجيل من حدّث حالة الموعد (updated_by) | مُنفَّذ (يتطلب تشغيل الـ migration) |
| عرض "أنشأه" و"آخر تحديث" في المهام وملف الزبون | مُنفَّذ |
| تعيين موظف للمتابعة / تقارير / إشعارات | مقترح للمستقبل |

بهذا يصبح كل تعامل مع الزبون أو مع موعد متابعة **موثقاً** بمعرف الموظف الذي أنشأ التفاعل أو حدّث الحالة، مع إمكانية عرض اسم المستخدم في الواجهة.
